SET SERVEROUTPUT ON

DECLARE
  V_STMT VARCHAR2(1024);
  V_CNT  INT;
BEGIN
  SELECT COUNT(*) INTO V_CNT FROM USER_TABLES WHERE TABLE_NAME = 'SRC_UNIQUE_INDEX'
  ;

  IF V_CNT = 1 THEN
    V_STMT := 'DROP TABLE SRC_UNIQUE_INDEX CASCADE CONSTRAINT PURGE'
    ;
    DBMS_OUTPUT.PUT_LINE(V_STMT)
    ;
    EXECUTE IMMEDIATE V_STMT
    ;
  END IF
  ;
END
;
/

CREATE TABLE SRC_UNIQUE_INDEX (
  OWNER             VARCHAR2(30)
  , INDEX_NAME      VARCHAR2(30)
  , INDEX_TYPE      VARCHAR2(27)
  , TABLE_NAME      VARCHAR2(30)
  , COLUMN_NAME     VARCHAR2(30)
  , COLUMN_POSITION NUMBER(2, 0)
  , CONSTRAINT_NAME VARCHAR2(30)
  , CONSTRAINT_TYPE VARCHAR2(1)
  , CONSTRAINT SRCINDEXX000 PRIMARY KEY (INDEX_NAME, TABLE_NAME, COLUMN_POSITION, CONSTRAINT_TYPE)
)
;
GRANT SELECT ON &1.SRC_UNIQUE_INDEX TO &1
;
GRANT UPDATE ON &1.SRC_UNIQUE_INDEX TO &1
;
GRANT INSERT ON &1.SRC_UNIQUE_INDEX TO &1
;
GRANT DELETE ON &1.SRC_UNIQUE_INDEX TO &1
;

INSERT INTO SRC_UNIQUE_INDEX
SELECT /*+ ORDERED USE_NL(I IC) */
  SYS_CONTEXT('USERENV', 'SESSION_USER')
  , I.INDEX_NAME
  , I.INDEX_TYPE
  , I.TABLE_NAME
  , IC.COLUMN_NAME
  , IC.COLUMN_POSITION
  , C.CONSTRAINT_NAME
  , C.CONSTRAINT_TYPE
FROM
  USER_CONSTRAINTS C INNER JOIN USER_INDEXES I
    ON C.TABLE_NAME = I.TABLE_NAME
    AND C.INDEX_NAME = I.INDEX_NAME
    AND C.CONSTRAINT_TYPE IN ('P', 'U')
    AND C.INDEX_NAME IS NOT NULL
  INNER JOIN USER_IND_COLUMNS IC
    ON I.INDEX_NAME = IC.INDEX_NAME
    AND I.TABLE_NAME = IC.TABLE_NAME
ORDER BY
  C.TABLE_NAME
  , C.INDEX_NAME
;
COMMIT
;

-- チェック用
--SET PAGESIZE 0
--SET LINESIZE 9999
--SET HEADING OFF
--SELECT
--  SYS_CONTEXT('USERENV', 'SESSION_USER')
--  || ',' || I.INDEX_NAME
--  || ',' || I.INDEX_TYPE
--  || ',' || I.TABLE_NAME
--  || ',' || IC.COLUMN_NAME
--  || ',' || IC.COLUMN_POSITION
--  || ',' || C.CONSTRAINT_NAME
--  || ',' || C.CONSTRAINT_TYPE
--FROM
--  USER_CONSTRAINTS C INNER JOIN USER_INDEXES I
--    ON C.TABLE_NAME = I.TABLE_NAME
--    AND C.INDEX_NAME = I.INDEX_NAME
--    AND C.CONSTRAINT_TYPE IN ('P', 'U')
--    AND C.INDEX_NAME IS NOT NULL
--  INNER JOIN USER_IND_COLUMNS IC
--    ON I.INDEX_NAME = IC.INDEX_NAME
--    AND I.TABLE_NAME = IC.TABLE_NAME
--ORDER BY
--  C.TABLE_NAME
--  , C.INDEX_NAME
--  , IC.COLUMN_POSITION
--;